name: Auto Merge Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  status: {}

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check CI Status
        id: ci-status
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Code Quality Check"
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Auto-merge if CI passes and conditions met
        if: steps.ci-status.outputs.conclusion == 'success'
        uses: pascalgn/automerge-action@v0.16.4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash
          update_method: rebase
          do_not_merge: true
          # Only merge if PR has 'auto-merge' label
          required_label: auto-merge
          # Don't merge if PR has these labels
          blocking_labels: do-not-merge,work-in-progress
          # Minimum approvals required
          minimum_approvals: 0
          # Don't merge if there are merge conflicts
          merge_failing: false